package priori;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;

public class Generator {
	private ArrayList<String[]> transactionData;
	private ArrayList<HashMap<String,Integer>> combinations;
	private ItemSet itemSet;
	private int level;
	
	public Generator(String transactionFile, String itemsFile) {
		TransactionSet transactions = new TransactionSet(transactionFile);
		this.transactionData = transactions.getItemsArray();
		this.itemSet = new ItemSet(itemsFile);
		this.combinations = new ArrayList<HashMap<String,Integer>>();
		this.level = 0;
		this.transactionValidation();
	}
	
	private void transactionValidation() {
		// Check for the existence of items in transactions
		// transactions that contain items that don't exist will be dropped
		ArrayList<Integer> index = new ArrayList<Integer>();
		for(int i=0; i< transactionData.size(); i++) {
			for(String item : transactionData.get(i)) {
				if(!itemSet.checkExistence(item)) {
					index.add(i);
				}
			}
		}
		// Drop transactions corresponding to the index #s recorded in index array
		for(Integer i : index) {
			transactionData.remove(i);
		}
	}
	
	public RuleSet generate(double minConfidenceLev, double minSupportLev) {
		int minSupportCount = (int)Math.round(transactionData.size() * minSupportLev);
		
		// Generating 1-itemSet Frequency table
		combinations.add(new HashMap<String,Integer>());
		for(String[] trans : transactionData) {
			for(int i=1; i<trans.length; i++) {
				Integer count = combinations.get(level).get(trans[i]);
				if(count != null) {
					combinations.get(level).put(trans[i], count + 1);
				} else {
					combinations.get(level).put(trans[i], 1);
				}
			}
		}
		
		ArrayList<String> toBeDel = new ArrayList<String>();
		Iterator<Entry<String, Integer>> it = combinations.get(level).entrySet().iterator();
		while(it.hasNext()) {
			Entry<String,Integer> item = it.next();
			if(item.getValue() < minSupportCount) {
				toBeDel.add(item.getKey());
			}
		}
		
		for(String key : toBeDel) {
			combinations.get(level).remove(key);
		}
		System.out.println(combinations.get(level));
		return null;
	}
	
	public static void main(String[] args) {
		Timer timer = new Timer();
		timer.start();
		
		Generator generator = new Generator("./Transactions.txt", "./Items.txt");
		RuleSet rules = generator.generate(0.5, 0.5);
		
		timer.stop();
	}
}
